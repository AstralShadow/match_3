NAME=match_3.js
CXX=em++
__CXXFLAGS=-O2 -std=c++11 \
	-Wall -Wpedantic -Wextra -g \
	-I/home/azcraft/workspace/cpp/sdl/libs-emsdk/include/ \
	#-L/home/azcraft/workspace/cpp/sdl/libs-emsdk/SDL/build \
	#-lSDL2 -lSDL2main
	# -lSDL2_image -lSDL2_ttf
	#  # -pthread

LDXX=em++
LDFLAGS= ${__CXXFLAGS} \
	-L/home/azcraft/workspace/cpp/sdl/libs-emsdk/SDL/build \
	-lSDL2 -lSDL2main
	# -lSDL2_image -lSDL2_ttf


IDIR=include
SDIR=src
BDIR=bin_ems
ODIR=obj_ems
DDIR=dep_ems

_CXXFLAGS = ${__CXXFLAGS} -I${IDIR} ${CXXFLAGS}
SRC = $(shell find ${SDIR} -type f -name '*.cpp' -o -name ".backup" -prune -type f)
OBJ = $(patsubst ${SDIR}/%.cpp,${ODIR}/%.o,${SRC})
DEP = $(patsubst ${SDIR}/%.cpp,${DDIR}/%.dep,${SRC})

ifndef VERBOSE
.SILENT:
endif

build: depend ${SRC} ${BDIR}/${NAME} html/*
	cp html/* ${BDIR}/

${DEP}: ${DDIR}/%.dep: ${SDIR}/%.cpp
	mkdir -p ${DDIR}
	echo "Calculating dependencies for $^"
	mkdir -p $$(dirname $@)
	${CXX} ${_CXXFLAGS} $^ -MM -MP -MT $(patsubst ${SDIR}/%.cpp,${ODIR}/%.o,$^) > $@

depend: ${DEP}
include ${DEP}

${OBJ}: ${ODIR}/%.o: ${SDIR}/%.cpp
	mkdir -p ${ODIR}
	echo "Compiling $@"
	mkdir -p $$(dirname $@)
	${CXX} -c -o $@ $< ${_CXXFLAGS}

${BDIR}/${NAME}: ${OBJ}
	mkdir -p ${BDIR}
	echo "Linking ${NAME}"
	$(LDXX) -o $@ ${OBJ} ${LDFLAGS}

clean:
	echo "Cleaning build files"
	rm -r ${ODIR} ${DDIR} tags

run: build
	echo "Running ${NAME}"
	${BDIR}/${NAME}

ctags: ${SRC}
	echo "Generating ctags"
	ctags -R ${IDIR} ${SDIR}
